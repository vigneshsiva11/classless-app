<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Current Setup Test - Classless AI Tutor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.working { background: #d4edda; color: #155724; }
        .status.broken { background: #f8d7da; color: #721c24; }
        .status.unknown { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .response {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .problem {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .solution {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîç Current Setup Diagnosis - Classless AI Tutor</h1>
    
    <div class="test-section">
        <h2>üìû Current Status</h2>
        <p><strong>Problem:</strong> Users calling/texting 04446313405 connect to you instead of AI</p>
        
        <div class="status unknown">
            üü° Status: Testing Required
        </div>
    </div>

    <div class="test-section">
        <h2>üß™ Test Current Setup</h2>
        <p>Let's test if your endpoints are working correctly:</p>
        
        <h3>Test 1: Voice Flow (Should Redirect to AI)</h3>
        <button onclick="testVoiceFlow()">Test Voice Flow</button>
        <div id="voice-result" class="response" style="display: none;"></div>
        
        <h3>Test 2: SMS Flow (Should Process with AI)</h3>
        <button onclick="testSMSFlow()">Test SMS Flow</button>
        <div id="sms-result" class="response" style="display: none;"></div>
        
        <h3>Test 3: Welcome Endpoint (Should Play Greeting)</h3>
        <button onclick="testWelcome()">Test Welcome</button>
        <div id="welcome-result" class="response" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üö® The Real Problem</h2>
        <div class="problem">
            <strong>Exotel is configured with WRONG webhook URLs!</strong><br><br>
            
            ‚ùå <strong>Current Voice Webhook:</strong> Probably `/api/ivr/incoming` or similar<br>
            ‚ùå <strong>Current SMS Webhook:</strong> Probably not `/api/sms/webhook`<br><br>
            
            Even though I fixed the code to redirect calls to AI, Exotel needs to be told to call the right endpoints in the first place.
        </div>
    </div>

    <div class="test-section">
        <h2>‚úÖ The Solution</h2>
        <div class="solution">
            <strong>Update Exotel Dashboard Configuration:</strong><br><br>
            
            1. <strong>Voice Webhook:</strong> Change to `/api/ivr/welcome`<br>
            2. <strong>SMS Webhook:</strong> Change to `/api/sms/webhook`<br><br>
            
            <strong>This will fix both voice calls AND SMS messages!</strong>
        </div>
    </div>

    <div class="test-section">
        <h2>üîß How to Fix Exotel</h2>
        <ol>
            <li><strong>Login to Exotel Dashboard</strong> at <a href="https://my.exotel.in/" target="_blank">https://my.exotel.in/</a></li>
            <li><strong>Go to Voice Configuration</strong></li>
            <li><strong>Find your number 04446313405</strong></li>
            <li><strong>Change Voice Webhook to:</strong> <code>/api/ivr/welcome</code></li>
            <li><strong>Go to SMS Configuration</strong></li>
            <li><strong>Change SMS Webhook to:</strong> <code>/api/sms/webhook</code></li>
            <li><strong>Save both configurations</strong></li>
            <li><strong>Test with a real call/SMS</strong></li>
        </ol>
    </div>

    <div class="test-section">
        <h2>üì± Test After Fix</h2>
        <p>Once you update Exotel:</p>
        
        <h3>Test Voice Call</h3>
        <ol>
            <li>Call <strong>04446313405</strong> from another phone</li>
            <li>You should hear: "Welcome to AI Tutor. Press 1 for SMS learning, Press 2 for Voice learning."</li>
            <li>Press <strong>2</strong> for voice learning</li>
            <li>Ask: "What is photosynthesis?"</li>
            <li><strong>AI should respond, not you!</strong></li>
        </ol>
        
        <h3>Test SMS</h3>
        <ol>
            <li>Send SMS to <strong>04446313405</strong> with text: "What is gravity?"</li>
            <li><strong>AI should respond via SMS, not you!</strong></li>
        </ol>
    </div>

    <script>
        const baseUrl = window.location.origin;
        
        function testVoiceFlow() {
            const resultDiv = document.getElementById('voice-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Testing voice flow...';
            
            // Test the incoming route (should redirect to welcome)
            const formData = new FormData();
            formData.append('CallSid', 'test_call_123');
            formData.append('From', '+91-9876543210');
            
            fetch(`${baseUrl}/api/ivr/incoming`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(result => {
                if (result.includes('Redirect') && result.includes('/api/ivr/welcome')) {
                    resultDiv.innerHTML = `‚úÖ SUCCESS! Voice flow is working correctly.\n\nResponse:\n${result}`;
                    resultDiv.className = 'response';
                } else {
                    resultDiv.innerHTML = `‚ùå ISSUE! Voice flow not redirecting properly.\n\nResponse:\n${result}`;
                    resultDiv.className = 'response';
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `‚ùå ERROR: ${error.message}`;
                resultDiv.className = 'response';
            });
        }
        
        function testSMSFlow() {
            const resultDiv = document.getElementById('sms-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Testing SMS flow...';
            
            // Test SMS webhook
            const smsData = {
                From: '+91-9876543210',
                Body: 'What is photosynthesis?',
                MessageSid: 'test_msg_123'
            };
            
            fetch(`${baseUrl}/api/sms/webhook`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(smsData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    resultDiv.innerHTML = `‚úÖ SUCCESS! SMS flow is working correctly.\n\nResponse:\n${JSON.stringify(result, null, 2)}`;
                    resultDiv.className = 'response';
                } else {
                    resultDiv.innerHTML = `‚ùå ISSUE! SMS flow not working properly.\n\nResponse:\n${JSON.stringify(result, null, 2)}`;
                    resultDiv.className = 'response';
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `‚ùå ERROR: ${error.message}`;
                resultDiv.className = 'response';
            });
        }
        
        function testWelcome() {
            const resultDiv = document.getElementById('welcome-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Testing welcome endpoint...';
            
            // Test welcome endpoint
            const formData = new FormData();
            formData.append('CallSid', 'test_call_123');
            formData.append('From', '+91-9876543210');
            
            fetch(`${baseUrl}/api/ivr/welcome`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(result => {
                if (result.includes('Welcome to AI Tutor')) {
                    resultDiv.innerHTML = `‚úÖ SUCCESS! Welcome endpoint is working correctly.\n\nResponse:\n${result}`;
                    resultDiv.className = 'response';
                } else {
                    resultDiv.innerHTML = `‚ùå ISSUE! Welcome endpoint not working properly.\n\nResponse:\n${result}`;
                    resultDiv.className = 'response';
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `‚ùå ERROR: ${error.message}`;
                resultDiv.className = 'response';
            });
        }
    </script>
</body>
</html>
